---
title: "Simulating Grouped Negative Binomial Counts with `scaffold`"
subtitle: "University of Florida - Dept. of Biostatistics - Bacher Group"
author: "Jack Leary"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    highlight: tango
    code_folding: show
    code_download: true
    toc: true
    toc_float:
      collpased: false
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      comment = NA, 
                      message = FALSE, 
                      warning = FALSE, 
                      fig.align = "center")
set.seed(312)  # lucky seed
```

# Libraries

```{r}
library(glm2)
library(dplyr)
library(scran)
library(scLANE)
library(scater)
library(ggplot2)
library(scaffold)
library(patchwork)
library(kableExtra)
library(SingleCellExperiment)
```

# Data 

First we'll simulate two different datasets with the same parameters using `scaffold`. We'll use 300 cells, and a dynamic gene rate of 10%. 

```{r}
ref.dataset <- scRNAseq::BaronPancreasData()
perc.dyn.genes <- .1
n.cells <- 300
n_dyn_genes <- ceiling(perc.dyn.genes * nrow(ref.dataset))
gene_knots <- matrix(runif(2 * n_dyn_genes, 0, 1), ncol = 2, nrow = n_dyn_genes)
theta_1 <- matrix(rnorm(5, 9, 5), ncol = 5, nrow = n_dyn_genes)
dynamic_params_1 <- list(propGenes = perc.dyn.genes,
                         degree = 2,
                         knots = gene_knots,
                         theta = theta_1)
dynamic_params_2 <- list(propGenes = perc.dyn.genes,
                         degree = 2,
                         knots = gene_knots,
                         theta = theta_1)
# simulate 10X dataset
scaffold_params_1 <- estimateScaffoldParameters(sce = ref.dataset,
                                                sceUMI = TRUE,
                                                useUMI = TRUE,
                                                protocol = "droplet",
                                                numCells = n.cells,
                                                popHet = c(1, 1),
                                                useDynamic = dynamic_params_1)
scaffold_params_2 <- estimateScaffoldParameters(sce = ref.dataset,
                                                sceUMI = TRUE,
                                                useUMI = TRUE,
                                                protocol = "droplet",
                                                numCells = n.cells,
                                                popHet = c(1, 1),
                                                useDynamic = dynamic_params_2)
sim_list <- list(P1 = simulateScaffold(scaffoldParams = scaffold_params_1, originalSCE = ref.dataset), 
                 P2 = simulateScaffold(scaffoldParams = scaffold_params_1, originalSCE = ref.dataset))
```

Next we'll need to create the `rowData` and `colData` for our `SingleCellExperiment` object, then process it using normalization, clustering, and dimension reduction as per usual. 

```{r}
counts_mat <- as.matrix(cbind(counts(sim_list[[1]]), counts(sim_list[[2]])))
col_names <- c(paste0("P1_", colnames(sim_list[[1]])), 
               paste0("P2_", colnames(sim_list[[1]])))
row_names <- rownames(sim_list[[1]])
rownames(counts_mat) <- row_names
colnames(counts_mat) <- col_names
row_data <- cbind(rowData(sim_list[[1]]), rowData(sim_list[[2]])) %>% as.data.frame()
colnames(row_data) <- paste0("geneStatus_", c("P1", "P2"))
row_data <- DataFrame(row_data)
col_data <- rbind(colData(sim_list[[1]]), colData(sim_list[[2]])) %>% 
            as.data.frame() %>% 
            mutate(subject = c(rep("P1", 300), rep("P2", 300)), 
                   cell_time_normed = c(1:300, 1:300) / 300)
rownames(col_data) <- col_names
col_data <- DataFrame(col_data)
sce <- SingleCellExperiment(list(counts = counts_mat))
colData(sce) <- col_data
rowData(sce) <- row_data

sce <- sce[which(rowSums(counts(sce) > 0) >= 5), ]
sce <- logNormCounts(sce)
var_decomp <- modelGeneVar(sce)
top2k_hvgs <- getTopHVGs(var_decomp, n = 2000)
sce <- runPCA(sce, subset_row = top2k_hvgs)
reducedDim(sce, "PCAsub") <- reducedDim(sce, "PCA")[, 1:10, drop = FALSE]
sce <- runUMAP(sce, dimred = "PCAsub", n_dimred = 1:10)
g <- buildSNNGraph(sce, use.dimred = "PCAsub", k = 30)
clusters <- igraph::cluster_louvain(graph = g)$membership
colLabels(sce) <- factor(clusters)
plotUMAP(sce, colour_by = "label")
plotUMAP(sce, colour_by = "subject")
```

# Analysis 

## `scLANE` with GLM Engine

```{r}
gene_stats <- testDynamic(expr.mat = as.matrix(t(sce@assays@data$counts)), 
                          pt = data.frame(PT = sce$cell_time_normed), 
                          parallel.exec = TRUE, 
                          n.cores =  6, 
                          n.potential.basis.fns = 3, 
                          track.time = TRUE)
global_test_results <- getResultsDE(gene_stats, p.adj.method = "bonferroni", fdr.cutoff = 0.01) %>% 
                       inner_join((rowData(sce) %>% 
                                   as.data.frame() %>% 
                                   mutate(gene = rownames(.))), by = c("Gene" = "gene"))
global_test_results %>% 
  mutate(geneStatus_Overall = as.factor(case_when(geneStatus_P1 == "Dynamic" & geneStatus_P2 == "Dynamic" ~ 1, TRUE ~ 0)), 
         geneStatus_MARGE = as.factor(Gene_Dynamic_Overall)) %>% 
  yardstick::conf_mat(truth = geneStatus_Overall, estimate = geneStatus_MARGE) %>% 
  summary() %>% 
  filter(.metric %in% c("accuracy", "sens", "spec", "bal_accuracy", "precision", "recall")) %>% 
  select(.metric, .estimate) %>% 
  mutate(.estimate = round(.estimate, 4)) %>% 
  kableExtra::kbl(col.names = c("Metric", "Estimate"), caption = "MARGE GLM Results") %>% 
  kableExtra::kable_paper(full_width = FALSE)
```

## `scLANE` with GEE Engine

```{r}
gene_stats_gee <- testDynamic(expr.mat = as.matrix(t(sce@assays@data$counts)), 
                              pt = data.frame(PT = sce$cell_time_normed), 
                              is.gee = TRUE, 
                              id.vec = sce$subject, 
                              cor.structure = "exchangeable", 
                              parallel.exec = TRUE, 
                              n.cores = 6, 
                              n.potential.basis.fns = 3, 
                              track.time = TRUE)
global_test_results_gee <- getResultsDE(gene_stats_gee, p.adj.method = "bonferroni", fdr.cutoff = 0.01) %>% 
                           inner_join((rowData(sce) %>% 
                                       as.data.frame() %>% 
                                       mutate(gene = rownames(.))), by = c("Gene" = "gene"))
global_test_results_gee %>% 
  mutate(geneStatus_Overall = as.factor(case_when(geneStatus_P1 == "Dynamic" & geneStatus_P2 == "Dynamic" ~ 1, TRUE ~ 0)), 
         geneStatus_MARGE = as.factor(Gene_Dynamic_Overall)) %>% 
  yardstick::conf_mat(truth = geneStatus_Overall, estimate = geneStatus_MARGE) %>% 
  summary() %>% 
  filter(.metric %in% c("accuracy", "sens", "spec", "bal_accuracy", "precision", "recall")) %>% 
  select(.metric, .estimate) %>% 
  mutate(.estimate = round(.estimate, 4)) %>% 
  kableExtra::kbl(col.names = c("Metric", "Estimate"), caption = "MARGE GEE Results") %>% 
  kableExtra::kable_paper(full_width = FALSE)
```


## Visualizations 

Let's check out a gene that is dynamic over pseudotime for both samples with the same pattern. This gene is detected as dynamic by both the GLM & GEE models. 

```{r}
data.frame(EXP = t(sce@assays@data$counts)[, top2k_hvgs[4]], 
           PT = sce$cell_time_normed, 
           SUB = sce$subject) %>% 
  ggplot(aes(x = PT, y = EXP, color = SUB)) + 
  geom_point() + 
  geom_smooth(method = "gam", color = "black") + 
  facet_wrap(~SUB) + 
  labs(x = "Pseudotime", 
       y = "Expression", 
       color = "Subject", 
       caption = "LOESS fit") + 
  theme_classic(base_size = 14) + 
  theme(plot.caption = element_text(face = "italic"))
plotModels(test.dyn.res = gene_stats, 
           gene.counts = t(sce@assays@data$counts), 
           pt = data.frame(PT = sce$cell_time_normed), 
           gene = top2k_hvgs[4]) + 
  labs(caption = "MARGE GLM fit") + 
  theme(plot.caption = element_text(face = "italic"))
plotModels(test.dyn.res = gene_stats_gee, 
           gene.counts = t(sce@assays@data$counts), 
           pt = data.frame(PT = sce$cell_time_normed), 
           gene = top2k_hvgs[4], 
           is.gee = TRUE, 
           id.vec = sce$subject, 
           cor.structure = "exchangeable") + 
  labs(caption = "MARGE GEE fit") + 
  theme(plot.caption = element_text(face = "italic"))
```

Next we'll check out a gene that is dynamic within each subject, but the patterns differ & thus look non-dynamic when combined. If this were a mixed-effect model we would probably deem the gene dynamic, but since the GEE framework gives us a population-level effect and the population-level effect is unclear, `scLANE` labels the gene as non-dynamic. 

```{r}
p1 <- data.frame(EXP = t(sce@assays@data$counts)[, top2k_hvgs[3]], 
                 PT = sce$cell_time_normed, 
                 SUB = sce$subject) %>% 
        ggplot(aes(x = PT, y = EXP, color = SUB)) + 
        geom_point() + 
        facet_wrap(~SUB) + 
        geom_smooth(method = "gam", color = "black") + 
        labs(x = NULL, y = "Expression", color = "Subject") + 
        theme_classic(base_size = 14)
p2 <- data.frame(EXP = t(sce@assays@data$counts)[, top2k_hvgs[3]], 
                 PT = sce$cell_time_normed, 
                 SUB = sce$subject) %>% 
        ggplot(aes(x = PT, y = EXP)) + 
        geom_point(color = "forestgreen") + 
        geom_smooth(color = "black") + 
        labs(x = "Pseudotime", y = "Expression", caption = "LOESS fit") + 
        theme_classic(base_size = 14) + 
        theme(plot.caption = element_text(face = "italic"))
p1 / p2
plotModels(test.dyn.res = gene_stats, 
           gene.counts = t(sce@assays@data$counts), 
           pt = data.frame(PT = sce$cell_time_normed), 
           gene = top2k_hvgs[3]) + 
  labs(caption = "MARGE GLM fit") + 
  theme(plot.caption = element_text(face = "italic"))
plotModels(test.dyn.res = gene_stats_gee, 
           gene.counts = t(sce@assays@data$counts), 
           pt = data.frame(PT = sce$cell_time_normed), 
           gene = top2k_hvgs[3], 
           is.gee = TRUE, 
           id.vec = sce$subject, 
           cor.structure = "exchangeable") + 
  labs(caption = "MARGE GEE fit") + 
  theme(plot.caption = element_text(face = "italic"))
```

# Save Data 

```{r, eval=FALSE}
saveRDS(gene_stats, file = "~/Desktop/gene_stats_scaffold_GEE_GLM.Rds")
saveRDS(gene_stats_gee, file = "~/Desktop/gene_stats_scaffold_GEE_GEE.Rds")
```
