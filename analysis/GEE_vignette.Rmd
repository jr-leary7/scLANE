---
title: "Identifying Dynamic Genes with Negative Binomial GEE Spline Models"
subtitle: "University of Florida - Dept. of Biostatistics - Bacher Group"
author: "Jack Leary"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: yeti
    highlight: tango
    code_folding: show
    code_download: true
    toc: true
    toc_float:
      collpased: false
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      comment = NA, 
                      message = FALSE, 
                      warning = FALSE, 
                      fig.align = "center")
set.seed(312)  # lucky seed
```

# Introduction 

In this vignette we'll focus on one of the more complicated features of `scLANE`: the usage of GEE models to identify dynamic genes when cells are grouped by some sort of subject identity. The robust variance estimation available in GEE models allows us to make more accurate decisions about which genes are actually dynamic over pseudotime / latent time. The downsides are that GEE models are a bit harder to understand than the default GLMs, and they take a little bit longer to estimate.  

# Libraries

```{r}
library(glm2)
library(dplyr)
library(scran)
library(scLANE)
library(scater)
library(ggplot2)
library(slingshot)
library(SingleCellExperiment)
```

# Data 

First we'll load in the lung tumor data from [Zilionis *et al* (2019)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6620049/), and subset to only include tumor neutrophils. The authors found 5 continuous tumor neutrophil subsets in their analysis, and we're interested in determining which genes drive subset-to-subset differentiation. The data were collected from 7 different patients, and thus the usage of GEE models is warranted in order to properly estimate within-patient gene expression correlations. 

```{r}
lung <- scRNAseq::ZilionisLungData(which = "human", filter = TRUE)
lung <- lung[, stringr::str_detect(lung$`Major cell type`, "tNeutrophils")]
```

## Preprocessing

First we'll preprocess the data in the typical way. We see that the neutrophils fall into 5 clusters, and that there is one odd outlier group of cells near the top of the UMAP plot. In addition, there is a decent amount of intra- and inter-patient variability. The cluster labels are not solely reflective of the cell subtypes, and seem to be driven by both patient identity as well as cell subtype. 

```{r}
lung <- logNormCounts(lung)
var_decomp <- modelGeneVar(lung)
top2k_hvgs <- getTopHVGs(var_decomp, n = 2000)
lung <- runPCA(lung, subset_row = top2k_hvgs)
reducedDim(lung, "PCAsub") <- reducedDim(lung, "PCA")[, 1:10, drop = FALSE]
lung <- runUMAP(lung, dimred = "PCAsub", n_dimred = 1:10)
g <- buildSNNGraph(lung, use.dimred = "PCAsub", k = 40)
clusters <- igraph::cluster_louvain(graph = g)$membership
colLabels(lung) <- factor(clusters)
plotUMAP(lung, colour_by = "label")
plotUMAP(lung, colour_by = "Patient")
plotUMAP(lung, colour_by = "Minor subset")
```

## Estimating Pseudotime

We'll use `slingshot` to estimate a pseudotime value for each cell. In this case, we see only one pseudotime lineage. 

```{r}
scl_lineage <- getLineages(reducedDim(lung, "PCAsub"), clusterLabels = clusters)
scl_crv <- getCurves(scl_lineage)
scl_cell_weights <- slingCurveWeights(scl_crv)
scl_pt <- slingPseudotime(scl_crv)
pt_df <- as.data.frame(scl_pt) %>% 
         mutate(across(everything(), function(x) x / max(x, na.rm = TRUE)))
```

# Running `scLANE` 

## Global Test

We're going to run `scLANE` solely on the top 10 most highly variable genes. This is for computational quickness, as otherwise the models would take a couple hours to run & this is a tutorial. Note that we need to provide a (sorted) vector of subject IDs as well as a working correlation structure. In this case we opt for the exchangeable (AKA compound symmetry) structure, as it stands to reason that within-subject cells will have similar correlations. 

```{r}
lung_counts <- t(lung@assays@data$counts)
lung_counts <- as.matrix(lung_counts[, which(colSums(lung_counts) > 0)])
gene_stats <- testDynamic(expr.mat = lung_counts[, colnames(lung_counts) %in% top2k_hvgs[1:10]], 
                          genes = top2k_hvgs[1:10], 
                          pt = pt_df, 
                          is.gee = TRUE, 
                          id.vec = lung$Patient, 
                          cor.structure = "exchangeable", 
                          parallel.exec = TRUE, 
                          n.cores = 4, 
                          track.time = TRUE)
```

Let's check out the results of the global differential expression test. 

```{r}
getResultsDE(gene_stats) %>% 
  select(-contains("LogLik"), -contains("Dev")) %>% 
  kableExtra::kbl(digits = 5, 
                  align = "c", 
                  booktabs = TRUE, 
                  caption = "Lineage-level dynamic test", 
                  col.names = c("Gene", "Lineage", "Test Stat.", "P-value", "Test Stat. Type", 
                                "Model Status", "Adj. P-value", "Gene Dynamic over Lineage", "Gene Dynamic")) %>% 
  kableExtra::kable_paper("hover", full_width = FALSE)
```

## Slope Test 

Next we can run the slope test to identify over which pseudotime intervals gene expression changes significantly. 

```{r}
testSlope(test.dyn.results = gene_stats) %>% 
  kableExtra::kbl(digits = 5, 
                  align = "c", 
                  booktabs = TRUE, 
                  caption = "Slope-level dynamic test", 
                  col.names = c("Gene", "Lineage", "Breakpoint", "Rounded Breakpoint", 
                                "Direction", "P-value", "Notes", "Adj. P-value", 
                                "Gene Dynamic over Lineage-Slope", "Gene Dynamic over Lineage", 
                                "Gene Dynamic")) %>% 
  kableExtra::kable_paper("hover", full_width = FALSE)
```

## Model Visualization 

Lastly, we can plot the fitted model for a couple of the genes. 

```{r, fig.width=4}
plotModels(test.dyn.res = gene_stats, 
           gene = "CXCL8", 
           pt = pt_df, 
           gene.counts = lung_counts, 
           is.gee = TRUE, 
           id.vec = lung$Patient, 
           cor.structure = "exchangeable")
plotModels(test.dyn.res = gene_stats, 
           gene = "RGS2", 
           pt = pt_df, 
           gene.counts = lung_counts, 
           is.gee = TRUE, 
           id.vec = lung$Patient, 
           cor.structure = "exchangeable")
```

# Session Info 

```{r}
sessioninfo::session_info()
```
